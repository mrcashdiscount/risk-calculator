<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High-Risk Provisional Compliance Score Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00BFA5; /* Emerald Accent */
            --primary-color-dark: #1DE9B6; /* Teal Accent */
            --base-dark: #0A192F; /* Deep Navy */
            --card-bg: #2C3E50; /* Charcoal */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--base-dark); /* Deep Navy Background */
        }
        /* Style for the active step in the progress bar */
        .step-indicator.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: var(--base-dark); /* Dark text on bright accent */
        }
        /* Style for selected radio buttons */
        .input-radio:checked + label {
            border-color: var(--primary-color);
            background-color: var(--card-bg);
            color: var(--primary-color-dark);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* Primary button styling */
        .btn-primary {
            background-color: var(--primary-color);
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: var(--primary-color-dark);
        }
        /* Custom shadow for score display */
        .shadow-custom {
            box-shadow: 0 20px 25px -5px rgba(0, 191, 165, 0.2), 0 8px 10px -6px rgba(0, 191, 165, 0.1);
        }
        /* Style for the new error message box */
        #errorMessage {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <!-- Calculator Container: Charcoal Card -->
    <div id="app-container" class="w-full max-w-2xl bg-[--card-bg] rounded-xl shadow-2xl shadow-gray-900 p-8 md:p-12 transition-all duration-300">
        <!-- Header / Above the Fold Copy -->
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-extrabold text-white leading-tight">
                Stop Losing Money to Hidden Fees and Account Holds.
            </h1>
            <h2 class="mt-3 text-xl font-medium text-gray-400">
                Instantly Calculate Your **Provisional Compliance Score** and Discover Your True High-Risk Processing Rate.
            </h2>
            <p class="mt-6 text-sm text-gray-500 max-w-md mx-auto">6 Questions. Less than 5 minutes.</p>
        </header>
        <!-- Progress Indicator -->
        <div id="progress-bar" class="flex justify-between items-center mb-8">
            <!-- Steps will be generated here by JS -->
        </div>
        <!-- Calculator Form -->
        <form id="riskForm" class="space-y-6">
            <!-- NEW: Inline Error Message Box (Teal Accent) -->
            <div id="errorMessage" class="hidden p-3 bg-gray-700 border border-[--primary-color-dark] text-[--primary-color-dark] rounded-lg font-medium transition-opacity" role="alert">
                <!-- Error message will be inserted here -->
            </div>
           
            <!-- Step 1: Vertical Risk -->
            <div data-step="1" class="step">
                <h3 class="text-2xl font-bold text-white mb-6">Question 1/6: Primary Vertical Risk</h3>
                <p class="text-gray-400 mb-6">Which best describes your primary product or service vertical?</p>
                <div class="space-y-4">
                    <input type="radio" id="dispensary" name="vertical" value="dispensary" class="hidden input-radio" required>
                    <label for="dispensary" class="block p-4 border-2 border-gray-600 rounded-lg cursor-pointer transition duration-200 text-gray-300 font-medium hover:border-[--primary-color]">Dispensaries (Cannabis - Critical Liability)</label>
                    <input type="radio" id="cbd_smoke" name="vertical" value="cbd_smoke" class="hidden input-radio">
                    <label for="cbd_smoke" class="block p-4 border-2 border-gray-600 rounded-lg cursor-pointer transition duration-200 text-gray-300 font-medium hover:border-[--primary-color]">CBD/Smoke Shops (High Liability)</label>
                    <input type="radio" id="convenience" name="vertical" value="convenience" class="hidden input-radio">
                    <label for="convenience" class="block p-4 border-2 border-gray-600 rounded-lg cursor-pointer transition duration-200 text-gray-300 font-medium hover:border-[--primary-color]">Convenience Stores (General Retail)</label>
                    <input type="radio" id="liquor" name="vertical" value="liquor" class="hidden input-radio">
                    <label for="liquor" class="block p-4 border-2 border-gray-600 rounded-lg cursor-pointer transition duration-200 text-gray-300 font-medium hover:border-[--primary-color]">Liquor Stores (Age-Restricted Sales)</label>
                    <input type="radio" id="ecomm" name="vertical" value="ecomm" class="hidden input-radio">
                    <label for="ecomm" class="block p-4 border-2 border-gray-600 rounded-lg cursor-pointer transition duration-200 text-gray-300 font-medium hover:border-[--primary-color]">High-Ticket E-commerce/Other (Standard High-Risk)</label>
                </div>
            </div>
            <!-- Step 2: Processing Volume -->
            <div data-step="2" class="step hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question 2/6: Processing Volume</h3>
                <p class="text-gray-400 mb-6">What is your estimated average monthly processing volume (USD)?</p>
                <div class="space-y-4">
                    <input type="radio" id="vol1" name="volume" value="<25k" class="hidden input-radio" required>
                    <label for="vol1" class="block p-4 border-2 border-gray-600 rounded-lg cursor-pointer transition duration-200 text-gray-300 font-medium hover:border-[--primary-color]">< $25K</label>
                    <input type="radio" id="vol2" name="volume" value="25k-100k" class="hidden input-radio">
                    <label for="vol2" class="block p-4 border-2 border-gray-600 rounded-lg cursor-pointer transition duration-200 text-gray-300 font-medium hover:border-[--primary-color]">$25K - $100K</label>
                    <input type="radio" id="vol3" name="volume" value="100k-250k" class="hidden input-radio">
                    <label for="vol3" class="block p-4 border-2 border-gray-600 rounded-lg cursor-pointer transition duration-200 text-gray-300 font-medium hover:border-[--primary-color]">$100K - $250K</label>
                    <input type="radio" id="vol4" name="volume" value=">250k" class="hidden input-radio">
                    <label for="vol4" class="block p-4 border-2 border-gray-600 rounded-lg cursor-pointer transition duration-200 text-gray-300 font-medium hover:border-[--primary-color]">> $250K (High Exposure)</label>
                </div>
            </div>
            <!-- Step 3: Subscription Percentage -->
            <div data-step="3" class="step hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question 3/6: Subscription Model</h3>
                <p class="text-gray-400 mb-6">What percentage of your sales are based on a recurring/subscription model?</p>
                <div class="space-y-4">
                    <input type="radio" id="sub0" name="sub_percent" value="0%" class="hidden input-radio" required>
                    <label for="sub0" class="block p-4 border-2 border-gray-600 rounded-lg cursor-pointer transition duration-200 text-gray-300 font-medium hover:border-[--primary-color]">0% (None)</label>
                    <input type="radio" id="sub25" name="sub_percent" value="<50%" class="hidden input-radio">
                    <label for="sub25" class="block p-4 border-2 border-gray-600 rounded-lg cursor-pointer transition duration-200 text-gray-300 font-medium hover:border-[--primary-color]">< 50%</label>
                    <input type="radio" id="sub75" name="sub_percent" value="50-75%" class="hidden input-radio">
                    <label for="sub75" class="block p-4 border-2 border-gray-600 rounded-lg cursor-pointer transition duration-200 text-gray-300 font-medium hover:border-[--primary-color]">50% - 75%</label>
                    <input type="radio" id="sub100" name="sub_percent" value=">75%" class="hidden input-radio">
                    <label for="sub100" class="block p-4 border-2 border-gray-600 rounded-lg cursor-pointer transition duration-200 text-gray-300 font-medium hover:border-[--primary-color]">> 75% (High Liability)</label>
                </div>
            </div>
            <!-- Step 4: ID Verification -->
            <div data-step="4" class="step hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question 4/6: Compliance Check</h3>
                <p class="text-gray-400 mb-6">Do you currently have compliant Age/Identity Verification (e.g., AVS, third-party ID check) integrated *before* payment on all restricted sales?</p>
                <div class="space-y-4">
                    <input type="radio" id="id_yes" name="id_check" value="yes" class="hidden input-radio" required>
                    <label for="id_yes" class="block p-4 border-2 border-gray-600 rounded-lg cursor-pointer transition duration-200 text-gray-300 font-medium hover:border-[--primary-color]">Yes, fully compliant</label>
                    <input type="radio" id="id_no" name="id_check" value="no" class="hidden input-radio">
                    <label for="id_no" class="block p-4 border-2 border-gray-600 rounded-lg cursor-pointer transition duration-200 text-gray-300 font-medium hover:border-[--primary-color]">No, or only partial coverage (High Gap Risk)</label>
                    <input type="radio" id="id_na" name="id_check" value="na" class="hidden input-radio">
                    <label for="id_na" class="block p-4 border-2 border-gray-600 rounded-lg cursor-pointer transition duration-200 text-gray-300 font-medium hover:border-[--primary-color]">Not Applicable (NA)</label>
                </div>
            </div>
            <!-- Step 5: Chargeback Ratio -->
            <div data-step="5" class="step hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question 5/6: Chargeback Ratio</h3>
                <p class="text-gray-400 mb-6">What is your current estimated monthly Chargeback Ratio? (Disputes รท Total Transactions)</p>
                <div class="space-y-4">
                    <input type="radio" id="cb1" name="cb_ratio" value="<0.5%" class="hidden input-radio" required>
                    <label for="cb1" class="block p-4 border-2 border-gray-600 rounded-lg cursor-pointer transition duration-200 text-gray-300 font-medium hover:border-[--primary-color]">< 0.5% (Stable)</label>
                    <input type="radio" id="cb2" name="cb_ratio" value="0.5%-0.9%" class="hidden input-radio">
                    <label for="cb2" class="block p-4 border-2 border-gray-600 rounded-lg cursor-pointer transition duration-200 text-gray-300 font-medium hover:border-[--primary-color]">0.5% - 0.9% (Elevated Risk)</label>
                    <input type="radio" id="cb3" name="cb_ratio" value="1.0%-1.5%" class="hidden input-radio">
                    <label for="cb3" class="block p-4 border-2 border-gray-600 rounded-lg cursor-pointer transition duration-200 text-gray-300 font-medium hover:border-[--primary-color]">1.0% - 1.5% (Warning Zone - Crisis Imminent)</label>
                    <input type="radio" id="cb4" name="cb_ratio" value=">1.5%" class="hidden input-radio">
                    <label for="cb4" class="block p-4 border-2 border-gray-600 rounded-lg cursor-pointer transition duration-200 text-gray-300 font-medium hover:border-[--primary-color]">> 1.5% (Critical Zone - Immediate Intervention Needed)</label>
                </div>
            </div>
            <!-- Step 6: AOV & Lead Capture -->
            <div data-step="6" class="step hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question 6/6: Average Order Value & Report Delivery</h3>
                <p class="text-gray-400 mb-6">What is your estimated Average Dollar Amount Per Transaction (AOV)?</p>
                <div class="mb-6">
                    <label for="aov" class="block text-sm font-medium text-gray-300 mb-2">AOV (USD):</label>
                    <input type="number" id="aov" name="aov" min="1" placeholder="e.g., 75.00" class="w-full p-3 border border-gray-600 rounded-lg focus:ring-[--primary-color] focus:border-[--primary-color] bg-gray-700 text-white" required>
                </div>
                <p class="text-gray-400 mb-6">To receive your full **Provisional Compliance Score**, estimated rate, and a custom **3-Step Mitigation Plan**, please enter your contact details.</p>
                <!-- NEW: First and Last Name Inputs -->
                <div class="flex space-x-4 mb-6">
                    <div class="flex-1">
                        <label for="first_name" class="block text-sm font-medium text-gray-300 mb-2">First Name:</label>
                        <input type="text" id="first_name" name="first_name" placeholder="John" class="w-full p-3 border border-gray-600 rounded-lg focus:ring-[--primary-color] focus:border-[--primary-color] bg-gray-700 text-white" required>
                    </div>
                    <div class="flex-1">
                        <label for="last_name" class="block text-sm font-medium text-gray-300 mb-2">Last Name:</label>
                        <input type="text" id="last_name" name="last_name" placeholder="Doe" class="w-full p-3 border border-gray-600 rounded-lg focus:ring-[--primary-color] focus:border-[--primary-color] bg-gray-700 text-white" required>
                    </div>
                </div>
                <!-- Existing Email Input -->
                <div class="mb-6">
                    <label for="email" class="block text-sm font-medium text-gray-300 mb-2">Work Email Address:</label>
                    <input type="email" id="email" name="email" placeholder="you@yourbusiness.com" class="w-full p-3 border border-gray-600 rounded-lg focus:ring-[--primary-color] focus:border-[--primary-color] bg-gray-700 text-white" required>
                </div>
            </div>
            <!-- Navigation & Loading -->
            <div id="nav-buttons" class="mt-8 flex justify-between">
                <button type="button" id="backBtn" class="px-6 py-3 border border-gray-600 rounded-lg text-gray-300 font-semibold hover:bg-gray-700 transition duration-200 disabled:opacity-50" disabled>
                    Back
                </button>
                <button type="button" id="nextBtn" class="px-6 py-3 btn-primary text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition duration-200">
                    Next
                </button>
                <button type="submit" id="submitBtn" class="px-6 py-3 btn-primary text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition duration-200 hidden">
                    Calculate My Score
                </button>
            </div>
            <div id="loadingMessage" class="hidden text-center mt-6">
                <div class="animate-spin inline-block w-6 h-6 border-4 border-[--primary-color] border-t-transparent rounded-full"></div>
                <p class="mt-2 text-[--primary-color] font-medium">Analyzing risk profile... Please wait.</p>
            </div>
        </form>
        <!-- Results Screen -->
        <div id="resultsScreen" class="hidden text-center p-8">
            <h3 class="text-3xl font-extrabold text-white mb-6">Your Risk Assessment is Complete!</h3>
            <!-- PCS Display Block -->
            <div class="mb-8 p-6 bg-gray-800 rounded-xl border border-[--primary-color]">
                <p class="text-xl font-medium text-gray-300">Your Provisional Compliance Score (PCS):</p>
                <div id="pcsDisplay" class="text-6xl font-black mt-2 inline-block px-6 py-3 rounded-xl shadow-custom text-white bg-[--primary-color]">
                    --
                </div>
                <p id="riskSummary" class="mt-4 font-semibold text-[--primary-color-dark]"></p>
            </div>
            <!-- Mitigation Plan and Rate -->
            <div class="text-left space-y-6">
                <h4 class="text-2xl font-bold text-white border-b border-gray-700 pb-2">Your Custom Mitigation Plan</h4>
                <div id="mitigationPlan" class="space-y-4"></div>
                <div class="pt-4 border-t border-gray-700 mt-6">
                    <h4 class="text-xl font-bold text-white mb-2">Estimated Interchange-Plus Rate:</h4>
                    <p id="rateEstimate" class="text-2xl font-semibold text-[--primary-color-dark]">--</p>
                </div>
                <p class="text-sm text-gray-500 mt-6">A full report will be sent to your email with a dedicated risk analyst's findings.</p>
            </div>
        </div>
    </div>
    <script>
        'use strict';
        // === CONFIGURATION ===
        // Note: The original Google Apps Script URL is kept here.
        const CRM_API_URL = 'https://script.google.com/macros/s/AKfycbzKllVWibDihT-UR2KvjLwW_YK0Y3pKoHyKn2m_KcN6EymBeVRCt1yk7_L2dNdG3IbC/exec';
       
        // Define theme colors used by JS for results display
        const THEME_COLORS = {
            low_risk_bg: '#00BFA5', // Emerald (High Score)
            low_risk_text: '#1DE9B6',
            mid_risk_bg: '#F59E0B', // Amber (Medium Score)
            mid_risk_text: '#D97706',
            high_risk_bg: '#EF4444', // Red (Low Score)
            high_risk_text: '#DC2626'
        };
        let currentStep = 1;
        const totalSteps = 6;
       
        // Caching DOM elements
        const form = document.getElementById('riskForm');
        const steps = form.querySelectorAll('.step');
        const nextBtn = document.getElementById('nextBtn');
        const backBtn = document.getElementById('backBtn');
        const submitBtn = document.getElementById('submitBtn');
        const loadingMessage = document.getElementById('loadingMessage');
        const resultsScreen = document.getElementById('resultsScreen');
        const appContainer = document.getElementById('app-container');
        const errorMessage = document.getElementById('errorMessage');
        // === UTILITY FUNCTIONS ===
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            // Ensure opacity transition happens after display change
            setTimeout(() => errorMessage.style.opacity = '1', 10);
        }
        function hideError() {
            errorMessage.style.opacity = '0';
            // Wait for transition to complete before hiding fully
            setTimeout(() => errorMessage.classList.add('hidden'), 300);
        }
       
        // === CORE FUNCTIONS ===
        function updateProgressBar() {
            const progressBar = document.getElementById('progress-bar');
            progressBar.innerHTML = '';
            for (let i = 1; i <= totalSteps; i++) {
                const isActive = i <= currentStep;
                const indicator = document.createElement('div');
                // The style definition takes care of the colors based on the CSS variables
                indicator.className = `step-indicator w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm border-2 transition-colors duration-300 ${isActive ? 'active' : 'bg-gray-600 text-gray-400 border-gray-700'}`;
                indicator.textContent = i;
                progressBar.appendChild(indicator);
            }
        }
        function showStep(stepIndex) {
            // Hide all steps first
            steps.forEach(step => step.classList.add('hidden'));
           
            // Show the current step
            const current = form.querySelector(`[data-step="${stepIndex}"]`);
            if (current) current.classList.remove('hidden');
           
            // Update navigation buttons
            backBtn.disabled = stepIndex === 1;
            if (stepIndex === totalSteps) {
                nextBtn.classList.add('hidden');
                submitBtn.classList.remove('hidden');
            } else {
                nextBtn.classList.remove('hidden');
                submitBtn.classList.add('hidden');
            }
           
            hideError(); // Clear any previous error on step change
            updateProgressBar();
        }
        function validateCurrentStep() {
            const currentStepElement = form.querySelector(`[data-step="${currentStep}"]`);
            // Check for both required text inputs and radio buttons
            const requiredInputs = currentStepElement.querySelectorAll('[required]');
           
            let isValid = true;
           
            // 1. Check specific required inputs (like AOV, First Name, Last Name, and Email in step 6)
            for (const input of requiredInputs) {
                if (!input.value) {
                    isValid = false;
                    break;
                }
            }
            // 2. Check radio groups (only needed for the radio steps 1-5)
            if (isValid && currentStep < totalSteps) {
                const radioGroups = new Set();
                currentStepElement.querySelectorAll('input[type="radio"]').forEach(radio => radioGroups.add(radio.name));
               
                for (const groupName of radioGroups) {
                    if (!form.querySelector(`input[name="${groupName}"]:checked`)) {
                        isValid = false;
                        break;
                    }
                }
            }
            if (!isValid) {
                showError('Please select an option or fill in all required fields to continue.');
            } else {
                hideError();
            }
            return isValid;
        }
        function nextStep() {
            if (validateCurrentStep() && currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep);
            }
        }
        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }
        // === PCS CALCULATION LOGIC (Updated for New Verticals) ===
        function calculatePCS(formData) {
            let pcs = 100;
            let riskSummary = "Stable and Optimized (Tier 3)";
            let rateEstimate = "IC + 0.15% + $0.15 (Waived Reserve)";
            let mitigationPlan = [
                "**Goal: Profit Optimization.** Maintain a clean compliance record. Focus on scaling.",
                "Review the Dual Pricing/Cash Discount model to move your effective rate to 0% and maximize savings.",
                "Consider setting up a **Multi-MID structure** for future scaling and risk diversification."
            ];
            // Vertical
            switch (formData.get('vertical')) {
                case 'dispensary': 
                    pcs -= 20; 
                    mitigationPlan[0] = "**Goal: Cannabis Compliance Mastery.** Strict adherence to state-specific licensing and federal banking restrictions."; 
                    break;
                case 'cbd_smoke': 
                    pcs -= 15; 
                    mitigationPlan[0] = "**Goal: Hemp Product Compliance.** Ensure all CBD products meet the 0.3% THC threshold and labeling requirements."; 
                    break;
                case 'convenience': 
                    pcs -= 5; 
                    mitigationPlan[0] = "**Goal: Retail Optimization.** Focus on inventory turnover and low-dispute transaction monitoring."; 
                    break;
                case 'liquor': 
                    pcs -= 12; 
                    mitigationPlan[0] = "**Goal: Alcohol Sales Compliance.** Implement robust age verification and delivery restrictions."; 
                    break;
                case 'ecomm': 
                    // No additional penalty for standard high-risk ecomm
                    break;
            }
            // Volume
            if (formData.get('volume') === '>250k') pcs -= 10;
            else if (formData.get('volume') === '100k-250k') pcs -= 5;
            // Subscription
            if (formData.get('sub_percent') === '>75%') pcs -= 10;
            else if (formData.get('sub_percent') === '50-75%') pcs -= 5;
            // ID Check
            if (formData.get('id_check') === 'no') {
                pcs -= 15;
                mitigationPlan.push("MANDATORY: Implement a compliant third-party Age/ID verification layer immediately.");
            }
            // Chargeback
            const cb = formData.get('cb_ratio');
            if (cb === '>1.5%') pcs -= 30;
            else if (cb === '1.0%-1.5%') pcs -= 15;
            else if (cb === '0.5%-0.9%') pcs -= 5;
            // Clamp PCS between 1 and 100
            pcs = Math.max(1, Math.min(100, pcs));
            if (pcs < 50) {
                riskSummary = "CRITICAL RISK (Tier 1) - IMMEDIATE INTERVENTION REQUIRED";
                rateEstimate = "IC + 0.55% + $0.30 (8% Rolling Reserve)";
                mitigationPlan.unshift("**CRISIS ALERT:** Your account is at immediate risk of termination or freeze.");
                mitigationPlan.push("MANDATORY: Integrate a **Real-Time Dispute Prevention (CDR)** service.");
            } else if (pcs < 75) {
                riskSummary = "ELEVATED RISK (Tier 2) - VULNERABLE";
                rateEstimate = "IC + 0.35% + $0.20 (3% Rolling Reserve)";
                mitigationPlan.unshift("**WARNING:** You have compliance gaps that will lead to higher fees.");
                mitigationPlan.push("RECOMMENDED: Set up basic fraud velocity filters and enhance your AVS/CVV checks.");
            }
            return { pcs, riskSummary, rateEstimate, mitigationPlan };
        }
        // === SUBMIT HANDLER ===
        async function handleSubmit(event) {
            event.preventDefault();
            if (!validateCurrentStep()) return;
            form.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            const formData = new FormData(form);
            const results = calculatePCS(formData);
            // All form data, including first_name and last_name, is collected here
            const submissionData = {
                timestamp: new Date().toISOString(),
                ...Object.fromEntries(formData),
                pcs_score: results.pcs,
                risk_tier: results.riskSummary.split(' - ')[0]
            };
            console.log('Sending to Google Sheets:', submissionData);
            try {
                // Using 'no-cors' mode is required for cross-domain Google Apps Script submission without CORS setup
                await fetch(CRM_API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(submissionData)
                });
                console.log('Data sent successfully (check Google Sheet)!');
            } catch (err) {
                // Catching error is mostly for development logging; the no-cors mode prevents useful error info.
                console.log('Fetch operation completed (or failed without visible status due to no-cors mode). Proceeding to display results.', err);
            } finally {
                loadingMessage.classList.add('hidden');
                displayResults(results);
            }
        }
        function displayResults(results) {
            // Determine colors based on score using the defined theme colors
            let bgColor = THEME_COLORS.high_risk_bg;
            let textColor = THEME_COLORS.high_risk_text;
            let rateColor = THEME_COLORS.high_risk_text;
            if (results.pcs >= 75) {
                bgColor = THEME_COLORS.low_risk_bg;
                textColor = THEME_COLORS.low_risk_text;
                rateColor = THEME_COLORS.low_risk_text;
            } else if (results.pcs >= 50) {
                bgColor = THEME_COLORS.mid_risk_bg;
                textColor = THEME_COLORS.mid_risk_text;
                rateColor = THEME_COLORS.mid_risk_text;
            }
            // Update DOM with results
            // Note: Uses arbitrary value classes [bg-...] and [text-...]
            appContainer.classList.add('shadow-custom');
           
            document.getElementById('pcsDisplay').textContent = results.pcs;
            document.getElementById('pcsDisplay').className = `text-6xl font-black mt-2 inline-block px-6 py-3 rounded-xl shadow-custom text-white bg-[${bgColor}]`;
           
            document.getElementById('riskSummary').textContent = results.riskSummary;
            document.getElementById('riskSummary').className = `mt-4 font-semibold text-[${textColor}]`;
           
            document.getElementById('rateEstimate').textContent = results.rateEstimate;
            document.getElementById('rateEstimate').className = `text-2xl font-semibold text-[${rateColor}]`;
            // Populate mitigation plan (adjusting colors for the list bullets)
            const planList = document.getElementById('mitigationPlan');
            planList.innerHTML = '';
            results.mitigationPlan.forEach((point, i) => {
                const div = document.createElement('div');
                div.className = 'flex items-start space-x-3';
                // Adjusting list item background and text to match the dark theme
                div.innerHTML = `<div class="flex-shrink-0 w-6 h-6 bg-[${bgColor}/10] text-[${textColor}] rounded-full flex items-center justify-center font-bold text-xs">${i + 1}</div><p class="text-gray-200 flex-1">${point}</p>`;
                planList.appendChild(div);
            });
            resultsScreen.classList.remove('hidden');
        }
        // === EVENT LISTENERS ===
        nextBtn.addEventListener('click', nextStep);
        backBtn.addEventListener('click', prevStep);
        form.addEventListener('submit', handleSubmit);
       
        // Handle 'Enter' key press for navigation
        form.addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                currentStep < totalSteps ? nextStep() : handleSubmit(e);
            }
        });
        // Initialize application on load
        window.onload = () => showStep(currentStep);
    </script>
</body>
</html>
